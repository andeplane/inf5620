\documentclass[a4paper,10pt]{article}
%\usepackage[latin1]{inputenc}
%\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{graphics}
\usepackage{bbm}
\usepackage{enumerate}
\usepackage{fullpage}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{hyperref}
\usepackage{ifsym}
\usepackage{parskip}
\usepackage[numbers,sectionbib]{natbib}

% Egne kommandoer for enklere vektornotasjon
\renewcommand{\vec}[1]{\mathbf{#1}}
\renewcommand{\(}{\left(}
\renewcommand{\)}{\right)}
%\renewcommand{\>}{\right>}
%\renewcommand{\<}{\left<}
\newcommand{\dm}[1]{\text{d}#1}
\newcommand{\dd}[2]{\frac{\mathrm{d}#1}{\mathrm{d}#2}}
\newcommand{\ddd}[2]{\frac{\mathrm{d^2}#1}{\mathrm{d}#2^2}}
\newcommand{\dpart}[2]{\frac{\partial#1}{\partial#2}}
\newcommand{\dpartt}[2]{\frac{\partial^2#1}{\partial#2^2}}

\usepackage{listings}
\usepackage{color}
\usepackage{textcomp}
\definecolor{listinggray}{gray}{0.9}
\definecolor{lbcolor}{rgb}{0.9,0.9,0.9}
\lstset{
 backgroundcolor=\color{white},
 tabsize=4,
 rulecolor=,
 language=c++, 
 basicstyle=\scriptsize,
 upquote=true,
 aboveskip={1.5\baselineskip},
 columns=fixed,
 showstringspaces=false,
 extendedchars=true,
 breaklines=true,
 prebreak = \raisebox{0ex}[0ex][0ex]{\ensuremath{\hookleftarrow}},
 frame=single,
 showtabs=false,
 showspaces=false,
 showstringspaces=false,
 identifierstyle=\ttfamily,
 keywordstyle=\color[rgb]{0,0,1},
 commentstyle=\color[rgb]{0.133,0.545,0.133},
 stringstyle=\color[rgb]{0.627,0.126,0.941},
}
\usepackage{subfig}
%\usepackage{wrapfig}
\usepackage{epstopdf}

\title{A numerical analysis of the Navier Stokes Equations}

\date{\today}
\author{Anders Hafreager}

\newenvironment{changemargin}[2]{%
 \begin{list}{}{%
 %\setlength{\topsep}{0pt}%
 \setlength{\leftmargin}{#1}%
 \setlength{\rightmargin}{#2}%
 %\setlength{\listparindent}{\parindent}%
 %\setlength{\itemindent}{\parindent}%
 %\setlength{\parsep}{\parskip}%
 }%
 \item[]}{\end{list}}
 
 \newcommand{\maxFigure}[4]{
 \begin{figure}[htp!]
 \begin{changemargin}{-3cm}{-1cm}
 \begin{center}
 %\includegraphics[width=\paperwidth + 3cm,height=\paperheight,keepaspectratio]{#2}
 \includegraphics[scale = #2]{#3}
 \end{center}
 \end{changemargin}
\vspace{-10pt}
  \caption{\textit{#1} }
  \label{#4}
 \end{figure}
 }
 
 \makeatletter
 \setlength{\abovecaptionskip}{6pt}   % 0.5cm as an example
\setlength{\belowcaptionskip}{6pt}   % 0.5cm as an example
% This does justification (left) of caption.
\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \sbox\@tempboxa{#1: #2}%
  \ifdim \wd\@tempboxa >\hsize
    #1: #2\par
  \else
    \global \@minipagefalse
    \hb@xt@\hsize{\box\@tempboxa\hfil}%
  \fi
  \vskip\belowcaptionskip}
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% DOCUMENT
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\maketitle
\section{Derivation}
There are many ways to derive the Navier Stokes Equations (NSE). Most of them are equivalent because they simply assume conservation of mass and momentum. This is also the approach we will do here. NSE describes the two most important properties in a fluid, namely the pressure $p$ and velocity field $\vec u$. We will use the notation of the material derivative 
\begin{align*}
  \frac{D}{Dt} = \dpart{}{t} + \vec u \cdot \nabla,
\end{align*}
and the integral theorems known from vector calculus.

\subsection{Conservation laws}
Consider a property $L$ that is measureable within a finite, arbitrary volume $\Omega$ with boundary $\partial \Omega$. The rate of change equals the amount that is created/consumed inside the volume or what flows through the boundary. This can be expressed as
\begin{align*}
  \frac{\dm }{\dm t} \int_\Omega L \dm V = -\int_{\partial \Omega} L\vec u \cdot \vec n \dm A - \int_\Omega Q \dm V,
\end{align*}
where $\vec n$ is the normal vector to the boundary pointing outwards, $\vec u$ is the fluid velocity and $Q$ represents the sources or sinks inside the fluid. If we apply the divergence theorem, this becomes
\begin{align*}
  \frac{\dm }{\dm t} \int_\Omega L \dm V = -\int_{\Omega} \nabla \cdot (L\vec u) \dm V - \int_\Omega Q \dm V,
\end{align*}
or simply
\begin{align*}
\int_\Omega \Bigg(\dpart{L}{t} + \nabla \cdot (L\vec u) + Q \Bigg)\dm V = 0.
\end{align*}
Since the volume $\Omega$ is arbitrary chosen, the integrand must be zero
\begin{align}
  \label{eq:conservation_law}
  \dpart{L}{t} + \nabla \cdot (L\vec u) + Q = 0.
\end{align}
This is the differential form of conservation laws that easily can be applied to any scalar field. It can also be used for vector fields by using dyadic tensors. This will be used to use the conservation law on the momentum $\rho \vec u$.
\subsection{Conservation of mass}
By assuming that no mass is created or destroyed, and applying the conservation equation on the mass, we get
\begin{align*}
  \dpart{\rho}{t} + \nabla \cdot (\rho\vec u) = 0.
\end{align*}
If the fluid is incompressible, we also have $\rho$ as a constant, reducing the above equation to
\begin{align}
  \label{eq:incompressible_fluid}
  \nabla \cdot \vec u = 0,
\end{align}
which will play an important part of choice of finite element formulation later on. 

\subsection{Conservation of momentum}
We apply the conservation law on the momentum per unit volume $\rho\vec u$
\begin{align*}
  \dpart{\rho\vec u}{t} + \nabla \cdot (\rho\vec u\vec u) + \vec Q = 0.
\end{align*}
The $Q$ term, the source or sink, is simply the body force, i.e. external forces that we denote by $\vec b$. The term with $\vec u\vec u$ is a dyad, i.e. a second rank tensor. This then becomes
\begin{align*}
  \vec u\dpart{\rho}{t} + \rho\dpart{\vec u}{t} + \vec u(\vec u\cdot\nabla \rho) + \rho\vec u(\nabla\cdot \vec u) + \rho(\vec u\cdot \nabla) \vec u = \vec b.
\end{align*}
Rearranging
\begin{align*}
  \vec b &= \vec u\Big(\dpart{\rho}{t} + \vec u\cdot \nabla \rho + \rho\nabla \cdot \vec u \Big) + \rho\Big( \dpart{\vec u}{t} + (\vec u\cdot \nabla) \vec u \Big)\\
  &= \vec u\Big(\dpart{\rho}{t} + \nabla\cdot(\rho\vec u) \Big) + \rho\Big( \dpart{\vec u}{t} + (\vec u\cdot \nabla) \vec u \Big).
\end{align*}
We recognize the first term as the mass conservation equation, which equals to zero, so conservation of momentum reduces to
\begin{align*}
  \vec b &= \rho\Big( \dpart{\vec u}{t} + (\vec u\cdot \nabla) \vec u \Big) = \rho\frac{D\vec u}{Dt},
\end{align*}
 where we have the material derivative of the fluid velocity multiplied with the density.
\subsection{The body force}
The source of momentum inside a volume is caused by body forces $\vec b$, but this again can be divided into different kinds of forces, distant forces like gravity or electrostatic forces, and a stress term (friction and normal forces, i.e. stress forces). By using the stress tensor, the body force can be written as
\begin{align*}
  \vec b = \nabla \cdot \vec \sigma + \vec f,
\end{align*}
which inserted in the momentum conservation looks like
\begin{align*}
  \rho \frac{D\vec u}{D t} = \nabla \cdot \vec \sigma + \vec f,
\end{align*}
where $\vec \sigma$ is the stress tensor, and $\vec f$ is the sum of distant forces. The stress tensor is defined in the usual way
\begin{align*}
  \vec \sigma &= 
  \left (
  \begin{array}{c c c}
  \sigma_x & \tau_{xy} & \tau_{xz}\\
  \tau_{yx} & \sigma_{y} & \tau_{yz}\\
  \tau_{zx} & \tau_{zy} & \sigma{z}
  \end{array}
  \right )\\
  &= -p\mathbbm 1 + \mathbbm T,
\end{align*}
where $\mathbbm 1$ is the identity matrix, $p$ is the average pressure
\begin{align*}
  p = -\frac{1}{3}(\sigma_x + \sigma_y + \sigma_z),
\end{align*}
and $\mathbbm T$ is the deviatoric stress tensor
\begin{align*}
  \mathbbm T &= 
  \left (
  \begin{array}{c c c}
  \sigma_x + p & \tau_{xy} & \tau_{xz}\\
  \tau_{yx} & \sigma_{y} + p & \tau_{yz}\\
  \tau_{zx} & \tau_{zy} & \sigma{z} + p
  \end{array}
  \right ).
\end{align*}
The conservation equation now looks like
\begin{align*}
  \rho \frac{D\vec u}{D t} = -\nabla p + \nabla\cdot \mathbbm T + \vec f.
\end{align*}
This is the Navier Stokes equation in its most general form. There are many degrees of freedom since $\mathbbm T$ can be defined in many different ways depending on the fluid properties. A usual simplification is to assume that the divergence of $\mathbbm T$ is proportional to $\nabla^2 \vec u$ with proportionality constant $\mu$
\begin{align*}
  \nabla \cdot \mathbbm T = \mu \nabla^2 \vec u,
\end{align*}
where $\mu$ is called viscosity, a sort of friction constant. NSE then looks like
\begin{align}
  \rho \frac{D\vec u}{D t} = -\nabla p + \mu\nabla^2 \vec u + \vec f.
\end{align}



\section{Numerical solution of the incompressible equation}
In order to solve this with a finite element method, we need to discretize the equation. The only time dependent part of the equation is in the material derivative. We will analyze this with different schemes. We rewrite NSE to
\begin{align*}
  \dpart{\vec u}{t} = \nu\nabla^2\vec u - \frac{1}{\rho}\nabla p + \vec f - (\vec u\cdot \nabla)\vec u,
\end{align*}
where we have defined the kinematic viscosity $\nu=\mu/\rho$, redifined $\vec f \rightarrow \vec f/\rho$, force per unit volume. We will use a scheme where we can exploit the fact that $\nabla \cdot \vec u = 0$ and manage to calculate $p^{n+1}$.
\subsection{The classical splitting method}
We use the Forward Euler method to find an expression for $\vec u^{n+1}$, but we evaluate the pressure also at the time step $n+1$. This will give an extra degree of freedom that we can use to make sure that $\vec u$ behaves as we know it should
\begin{align*}
  \vec u^{n+1} = \vec u^{n} + \Delta t\nu\nabla^2\vec u^n - \frac{\Delta t}{\rho}\nabla p^{n+1} + \Delta t\vec f - \Delta t(\vec u^n\cdot \nabla)\vec u^n.
\end{align*}
It is now possible to choose $\nabla p^{n+1}$ so that $\nabla \cdot \vec u^{n+1} = 0$. We will do this by using a temporary $\vec u^*$ which we define as
\begin{align}
  \label{eq:ustar}
  \vec u^* = \vec u^{n} + \Delta t\nu\nabla^2\vec u^n - \beta\frac{\Delta t}{\rho}\nabla p^n + \Delta t\vec f - \Delta t(\vec u^n\cdot \nabla)\vec u^n,
\end{align}
note the factor $\beta$ in the pressure gradient term. We choose a $\delta \vec u$ so that
\begin{align*}
  \vec u^{n+1} &= \vec u^* + \delta \vec u\\
  \delta \vec u &= \vec u^{n+1} - \vec u^*\\
  &= -\frac{\Delta t}{\rho}\Big(\nabla p^{n+1} - \beta\nabla p^n\Big) = -\frac{\Delta t}{\rho}\nabla \Phi,
\end{align*}
where $\Phi = p^{n-1} - \beta p^n$. The incompressibility constraint can now be written as
\begin{align*}
  \nabla \cdot \vec u^{n+1} &= \nabla\cdot(\vec u^* + \delta \vec u) = 0,
\end{align*}
or
\begin{align*}
  \nabla \cdot \vec u^* &= -\nabla \cdot\delta \vec u.
\end{align*}
We use this on our expression for $\delta \vec u$
\begin{align*}
  \nabla^2 \Phi = \frac{\rho}{\Delta t}\nabla \cdot \vec u^*,
\end{align*}
and recognize this as a Poisson equation for $\Phi$ that can be solved since we know $\vec u^*$. We now have everything we need to evolve the system in time where the velocity is given as
\begin{align}
  \label{eq:u_next}
  \vec u^{n+1} = \vec u^* - \frac{\Delta t}{\rho}\nabla \Phi,
\end{align}
and the pressure
\begin{align}
  \label{eq:p_next}
  \vec p^{n+1} = \Phi + \beta p^n.
\end{align}


\section{A Finite Element Method}
A popular way to solve the NSE is by using a finite element method. We will work through the details by looking at one part at the time. Assume now that we have given the initial pressure field $p$ and the initial velocity field $\vec u_0$. Following the recipe described above, we start by finding the $\vec u^*$. 
\subsection{Variational form for $\vec u^*$}
We introduce basis vectors living in the test space $V^{(u)}$, and seek $\vec u^*, \vec u^{n+1} \in V^{(u)}$. We create a variational form of \eqref{eq:ustar} by multiplying by a test vector $v\in V^{(u)}$ and integrate
\begin{align*}
  \frac{1}{\Delta t}\int_\Omega(\vec u^* - \vec u^{n})\cdot\vec v^{(u)}\dm \Omega
  &- \nu\int_\Omega (\nabla^2\vec u^n)\cdot\vec v^{(u)} \dm \Omega\\
   &+ \frac{\beta}{\rho}\int_\Omega\nabla p^n \cdot\vec v^{(u)} \dm \Omega 
   - \int_\Omega\vec f\cdot\vec v^{(u)} \dm \Omega 
   + \int_\Omega(\vec u^n\cdot \nabla)\vec u^n\cdot\vec v^{(u)} \dm \Omega = 0.
\end{align*}
By integrating the Laplace term and the pressure term by parts, we get
\begin{align*}
  \frac{1}{\Delta t}\int_\Omega(\vec u^* - \vec u^{n})\cdot\vec v^{(u)}\dm \Omega
  &+ \nu\int_\Omega\nabla\vec u^n\cdot\nabla\vec v^{(u)} \dm \Omega\\
   &- \frac{\beta}{\rho}\int_\Omega p^n \nabla\cdot\vec v^{(u)} \dm \Omega 
   - \int_\Omega\vec f\cdot\vec v^{(u)} \dm \Omega 
   + \int_\Omega (\vec u^n\cdot \nabla)\vec u^n\cdot\vec v^{(u)} \dm \Omega\\
   &= \int_{\partial\Omega} (\nu\dpart{\vec u}{n} - p\vec n)\cdot\vec v^{(u)} \dm s
\end{align*}
\subsection{Variational form for $\Phi$}
To solve the Poisson equation for $\Phi$, we multiply by a test function $v^{(\Phi)} \in V^{(\Phi)}$ and integrate
\begin{align*}
  \int_\Omega \nabla^2\Phi v^{(\Phi)} \dm \Omega &= \frac{\rho}{\Delta t} \int_\Omega \nabla \cdot \vec u^* v^{(\Phi)} \dm \Omega\\
  \int_\Omega \nabla\Phi \cdot \nabla v^{(\Phi)} \dm \Omega &= -\frac{\rho}{\Delta t} \int_\Omega \nabla \cdot \vec u^* v^{(\Phi)} \dm \Omega + \int_{\partial \Omega_{n,\Phi}} \dpart{\Phi}{n}v^{(\Phi)} \dm s
\end{align*}
When we have found $\Phi$ and $\vec u^*$, we can use a variational form of \eqref{eq:u_next}
\begin{align*}
  \int_\Omega \vec u^{n+1}\cdot \vec v^{(u)} \dm \Omega = \int_\Omega (\vec u^* - \frac{\Delta t}{\rho}\nabla \Phi)\cdot \vec v^{(u)} \dm \Omega,
\end{align*}
similarly for the pressure
\begin{align*}
  \int_\Omega p^{n+1}v^{(\Phi)} \dm \Omega = \int_\Omega (\Phi + \beta p^n)v^{(\Phi)} \dm \Omega.
\end{align*}
\section{Implementation in FEniCS}

\end{document}
